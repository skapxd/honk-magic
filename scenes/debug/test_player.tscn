[gd_scene load_steps=6 format=3 uid="uid://test_player_scene"]

[ext_resource type="Theme" uid="uid://canhs6wcwwphu" path="res://resources/theme/honk_theme.tres" id="1_theme"]
[ext_resource type="Script" path="res://scenes/debug/debug_grid.gd" id="2_grid"]

[sub_resource type="CircleShape2D" id="CircleShape2D_player"]
radius = 30.0

[sub_resource type="GDScript" id="GDScript_test_player"]
script/source = "extends Node2D

# =============================================================================
# HONK MAGIC - Test Player Scene
# =============================================================================
# Sandbox para probar movimiento RTS del jugador.

@onready var player: CharacterBody2D = $Player
@onready var camera: Camera2D = $Player/Camera2D
@onready var debug_label: Label = $CanvasLayer/DebugHUD/VBoxContainer/DebugLabel
@onready var fps_label: Label = $CanvasLayer/DebugHUD/VBoxContainer/FPSLabel

var _target_indicator: Node2D = null


func _ready() -> void:
	_create_target_indicator()


func _process(_delta: float) -> void:
	_update_debug_hud()


func _update_debug_hud() -> void:
	if debug_label and player:
		debug_label.text = \"Pos: (%.0f, %.0f)\" % [player.global_position.x, player.global_position.y]
	if fps_label:
		fps_label.text = \"FPS: %d\" % Engine.get_frames_per_second()


func _create_target_indicator() -> void:
	_target_indicator = Node2D.new()
	_target_indicator.set_script(preload(\"res://scenes/debug/target_indicator.gd\"))
	_target_indicator.visible = false
	add_child(_target_indicator)


func _unhandled_input(event: InputEvent) -> void:
	if event.is_action_pressed(\"secondary_action\"):
		var target_pos := get_global_mouse_position()
		player.move_to(target_pos)
		_show_target_indicator(target_pos)

	if event.is_action_pressed(\"pause\"):
		_on_back_pressed()


func _show_target_indicator(pos: Vector2) -> void:
	if _target_indicator:
		_target_indicator.global_position = pos
		_target_indicator.visible = true
		_target_indicator.start_animation()


func _on_back_pressed() -> void:
	SceneTransition.change_scene(\"res://scenes/debug/debug_menu.tscn\")
"

[sub_resource type="GDScript" id="GDScript_player"]
script/source = "extends CharacterBody2D

# =============================================================================
# HONK MAGIC - Player (Test Version)
# =============================================================================

@export var speed: float = 300.0
@export var player_color: Color = Color(0.88, 0.88, 0.88)
@export var player_size: float = 30.0

var target_position: Vector2 = Vector2.ZERO
var is_moving: bool = false

@onready var visual: Polygon2D = $Visual


func _ready() -> void:
	target_position = global_position
	_create_hexagon_visual()


func _create_hexagon_visual() -> void:
	if not visual:
		return

	var points: PackedVector2Array = []
	for i in range(6):
		var angle := i * TAU / 6.0 - PI / 6.0
		points.append(Vector2(cos(angle), sin(angle)) * player_size)

	visual.polygon = points
	visual.color = player_color


func move_to(pos: Vector2) -> void:
	target_position = pos
	is_moving = true


func _physics_process(_delta: float) -> void:
	if not is_moving:
		return

	var direction := (target_position - global_position).normalized()
	var distance := global_position.distance_to(target_position)

	if distance > 5.0:
		velocity = direction * speed
		move_and_slide()

		# Rotar suavemente hacia la dirección
		visual.rotation = lerp_angle(visual.rotation, direction.angle() + PI / 2, 0.1)
	else:
		velocity = Vector2.ZERO
		is_moving = false
"

[node name="TestPlayer" type="Node2D"]
script = SubResource("GDScript_test_player")

[node name="Background" type="ColorRect" parent="."]
offset_left = -2000.0
offset_top = -2000.0
offset_right = 2000.0
offset_bottom = 2000.0
color = Color(0.086, 0.129, 0.18, 1)

[node name="Grid" type="Node2D" parent="."]
script = ExtResource("2_grid")

[node name="Player" type="CharacterBody2D" parent="."]
script = SubResource("GDScript_player")

[node name="Visual" type="Polygon2D" parent="Player"]
color = Color(0.878431, 0.878431, 0.878431, 1)
polygon = PackedVector2Array(26, -15, 26, 15, 0, 30, -26, 15, -26, -15, 0, -30)

[node name="CollisionShape2D" type="CollisionShape2D" parent="Player"]
shape = SubResource("CircleShape2D_player")

[node name="Camera2D" type="Camera2D" parent="Player"]
position_smoothing_enabled = true
position_smoothing_speed = 5.0

[node name="CanvasLayer" type="CanvasLayer" parent="."]

[node name="DebugHUD" type="PanelContainer" parent="CanvasLayer"]
offset_left = 10.0
offset_top = 10.0
offset_right = 200.0
offset_bottom = 80.0
theme = ExtResource("1_theme")

[node name="VBoxContainer" type="VBoxContainer" parent="CanvasLayer/DebugHUD"]
layout_mode = 2
theme_override_constants/separation = 4

[node name="FPSLabel" type="Label" parent="CanvasLayer/DebugHUD/VBoxContainer"]
layout_mode = 2
theme_override_font_sizes/font_size = 16
text = "FPS: 60"

[node name="DebugLabel" type="Label" parent="CanvasLayer/DebugHUD/VBoxContainer"]
layout_mode = 2
theme_override_font_sizes/font_size = 16
text = "Pos: (0, 0)"

[node name="BackButton" type="Button" parent="CanvasLayer"]
auto_translate_mode = 1
offset_left = 10.0
offset_top = 90.0
offset_right = 130.0
offset_bottom = 130.0
theme = ExtResource("1_theme")
text = "MENU_BACK"

[node name="InstructionsLabel" type="Label" parent="CanvasLayer"]
offset_left = 10.0
offset_top = 140.0
offset_right = 350.0
offset_bottom = 200.0
theme = ExtResource("1_theme")
theme_override_colors/font_color = Color(0.7, 0.7, 0.7, 1)
theme_override_font_sizes/font_size = 14
text = "Click derecho: mover jugador
ESC: volver al menú"

[connection signal="pressed" from="CanvasLayer/BackButton" to="." method="_on_back_pressed"]
