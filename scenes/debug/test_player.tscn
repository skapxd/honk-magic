[gd_scene load_steps=8 format=3 uid="uid://bblfk0nbxbtry"]

[ext_resource type="Theme" uid="uid://canhs6wcwwphu" path="res://resources/theme/honk_theme.tres" id="1_theme"]
[ext_resource type="Script" uid="uid://yhwtam8bv7du" path="res://scenes/debug/debug_grid.gd" id="2_grid"]
[ext_resource type="Script" uid="uid://cvvs8ogjyonwu" path="res://scripts/core/selection_manager.gd" id="3_selection"]
[ext_resource type="Script" uid="uid://br5qfwuf7jgue" path="res://scenes/debug/selection_visual.gd" id="4_sel_visual"]

[sub_resource type="GDScript" id="GDScript_test_player"]
script/source = "extends Node2D

# =============================================================================
# HONK MAGIC - Test Player Scene (RTS)
# =============================================================================
# Sandbox para probar mecánicas RTS: selección y movimiento.

@onready var player: CharacterBody2D = $Player
@onready var camera: Camera2D = $Player/Camera2D
@onready var selection_manager: SelectionManager = $SelectionManager
@onready var debug_label: Label = $CanvasLayer/DebugHUD/VBoxContainer/DebugLabel
@onready var fps_label: Label = $CanvasLayer/DebugHUD/VBoxContainer/FPSLabel
@onready var selection_label: Label = $CanvasLayer/DebugHUD/VBoxContainer/SelectionLabel

var _target_indicator: Node2D = null


func _ready() -> void:
	_create_target_indicator()
	selection_manager.move_command.connect(_on_move_command)
	selection_manager.selection_changed.connect(_on_selection_changed)


func _process(_delta: float) -> void:
	_update_debug_hud()


func _update_debug_hud() -> void:
	if debug_label and player:
		debug_label.text = \"Pos: (%.0f, %.0f)\" % [player.global_position.x, player.global_position.y]
	if fps_label:
		fps_label.text = \"FPS: %d\" % Engine.get_frames_per_second()


func _create_target_indicator() -> void:
	_target_indicator = Node2D.new()
	_target_indicator.set_script(preload(\"res://scenes/debug/target_indicator.gd\"))
	_target_indicator.visible = false
	add_child(_target_indicator)


func _on_move_command(target_pos: Vector2, units: Array) -> void:
	for unit in units:
		if is_instance_valid(unit) and unit.has_method(\"move_to\"):
			unit.move_to(target_pos)
	_show_target_indicator(target_pos)


func _on_selection_changed(units: Array) -> void:
	if selection_label:
		selection_label.text = \"Sel: %d\" % units.size()


func _show_target_indicator(pos: Vector2) -> void:
	if _target_indicator:
		_target_indicator.global_position = pos
		_target_indicator.visible = true
		_target_indicator.start_animation()


func _on_back_pressed() -> void:
	SceneTransition.change_scene(\"res://scenes/debug/debug_menu.tscn\")


func _input(event: InputEvent) -> void:
	if event.is_action_pressed(\"pause\"):
		_on_back_pressed()
"

[sub_resource type="GDScript" id="GDScript_player"]
script/source = "extends CharacterBody2D

# =============================================================================
# HONK MAGIC - Player (RTS Version)
# =============================================================================
# Jugador con selección visual y movimiento RTS.

@export var speed: float = 300.0
@export var player_color: Color = Color(0.88, 0.88, 0.88)
@export var selection_color: Color = Color(0, 0.961, 0.831, 0.8)
@export var player_size: float = 30.0

var target_position: Vector2 = Vector2.ZERO
var is_moving: bool = false
var is_selected: bool = false:
	set(value):
		is_selected = value
		_update_selection_visual()

@onready var visual: Polygon2D = $Visual
@onready var selection_visual: Node2D = $SelectionVisual


func _ready() -> void:
	add_to_group(\"selectable\")
	target_position = global_position
	_create_hexagon_visual()
	_update_selection_visual()


func _create_hexagon_visual() -> void:
	if not visual:
		return

	var points: PackedVector2Array = []
	for i in range(6):
		var angle := i * TAU / 6.0 - PI / 6.0
		points.append(Vector2(cos(angle), sin(angle)) * player_size)

	visual.polygon = points
	visual.color = player_color


func _update_selection_visual() -> void:
	if selection_visual:
		selection_visual.visible = is_selected
		selection_visual.queue_redraw()


func set_selected(value: bool) -> void:
	is_selected = value


func move_to(pos: Vector2) -> void:
	target_position = pos
	is_moving = true


func _physics_process(_delta: float) -> void:
	if not is_moving:
		return

	var direction := (target_position - global_position).normalized()
	var distance := global_position.distance_to(target_position)

	if distance > 5.0:
		velocity = direction * speed
		move_and_slide()

		# Rotar suavemente hacia la dirección
		visual.rotation = lerp_angle(visual.rotation, direction.angle() + PI / 2, 0.1)
	else:
		velocity = Vector2.ZERO
		is_moving = false
"

[sub_resource type="CircleShape2D" id="CircleShape2D_player"]
radius = 30.0

[node name="TestPlayer" type="Node2D"]
script = SubResource("GDScript_test_player")

[node name="Background" type="ColorRect" parent="."]
offset_left = -2000.0
offset_top = -2000.0
offset_right = 2000.0
offset_bottom = 2000.0
color = Color(0.086, 0.129, 0.18, 1)

[node name="Grid" type="Node2D" parent="."]
script = ExtResource("2_grid")

[node name="SelectionManager" type="Node2D" parent="."]
script = ExtResource("3_selection")

[node name="Player" type="CharacterBody2D" parent="."]
script = SubResource("GDScript_player")

[node name="Visual" type="Polygon2D" parent="Player"]
color = Color(0.878431, 0.878431, 0.878431, 1)
polygon = PackedVector2Array(26, -15, 26, 15, 0, 30, -26, 15, -26, -15, 0, -30)

[node name="SelectionVisual" type="Node2D" parent="Player"]
visible = false
script = ExtResource("4_sel_visual")

[node name="CollisionShape2D" type="CollisionShape2D" parent="Player"]
shape = SubResource("CircleShape2D_player")

[node name="Camera2D" type="Camera2D" parent="Player"]
position_smoothing_enabled = true

[node name="CanvasLayer" type="CanvasLayer" parent="."]

[node name="DebugHUD" type="PanelContainer" parent="CanvasLayer"]
offset_left = 10.0
offset_top = 10.0
offset_right = 200.0
offset_bottom = 100.0
theme = ExtResource("1_theme")

[node name="VBoxContainer" type="VBoxContainer" parent="CanvasLayer/DebugHUD"]
layout_mode = 2
theme_override_constants/separation = 4

[node name="FPSLabel" type="Label" parent="CanvasLayer/DebugHUD/VBoxContainer"]
layout_mode = 2
theme_override_font_sizes/font_size = 16
text = "FPS: 60"

[node name="DebugLabel" type="Label" parent="CanvasLayer/DebugHUD/VBoxContainer"]
layout_mode = 2
theme_override_font_sizes/font_size = 16
text = "Pos: (0, 0)"

[node name="SelectionLabel" type="Label" parent="CanvasLayer/DebugHUD/VBoxContainer"]
layout_mode = 2
theme_override_font_sizes/font_size = 16
text = "Sel: 0"

[node name="BackButton" type="Button" parent="CanvasLayer"]
auto_translate_mode = 1
offset_left = 10.0
offset_top = 110.0
offset_right = 130.0
offset_bottom = 150.0
theme = ExtResource("1_theme")
text = "MENU_BACK"

[node name="InstructionsLabel" type="Label" parent="CanvasLayer"]
offset_left = 10.0
offset_top = 160.0
offset_right = 400.0
offset_bottom = 240.0
theme = ExtResource("1_theme")
theme_override_colors/font_color = Color(0.7, 0.7, 0.7, 1)
theme_override_font_sizes/font_size = 14
text = "Click izquierdo: seleccionar
Arrastrar: caja de selección
Click derecho: mover seleccionados
ESC: volver al menú"

[connection signal="pressed" from="CanvasLayer/BackButton" to="." method="_on_back_pressed"]
