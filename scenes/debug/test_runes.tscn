[gd_scene load_steps=4 format=3 uid="uid://test_runes_scene"]

[ext_resource type="Shader" uid="uid://bl2j4hm0jk4sd" path="res://assets/shaders/fog_background.gdshader" id="1_shader"]
[ext_resource type="Theme" uid="uid://canhs6wcwwphu" path="res://resources/theme/honk_theme.tres" id="2_theme"]

[sub_resource type="GDScript" id="GDScript_test_runes"]
script/source = "extends Control

# =============================================================================
# HONK MAGIC - Test Runes (Debug Scene)
# =============================================================================
# Escena de prueba para el sistema de reconocimiento de runas.

@onready var line_2d: Line2D = $DrawArea/Line2D
@onready var feedback_label: Label = $UI/FeedbackPanel/FeedbackLabel
@onready var rune_list: VBoxContainer = $UI/RuneListPanel/VBoxContainer/RuneList
@onready var history_list: VBoxContainer = $UI/HistoryPanel/VBoxContainer/HistoryList

var recognizer: DollarRecognizer
var points: Array[Vector2] = []
var is_drawing: bool = false

const ELEMENT_COLORS := {
	\"fuego\": Color(\"#e63946\"),
	\"agua\": Color(\"#0077b6\"),
	\"viento\": Color(\"#90e0ef\"),
	\"tierra\": Color(\"#bc6c25\"),
	\"luz\": Color(\"#ffd60a\"),
	\"oscuridad\": Color(\"#7b2cbf\")
}


func _ready() -> void:
	recognizer = DollarRecognizer.new()
	_setup_line()
	_populate_rune_list()
	_update_feedback(\"Dibuja una runa con el mouse\", Color.WHITE)


func _setup_line() -> void:
	if line_2d:
		line_2d.width = 8.0
		line_2d.default_color = Color(\"#00f5d4\")
		line_2d.begin_cap_mode = Line2D.LINE_CAP_ROUND
		line_2d.end_cap_mode = Line2D.LINE_CAP_ROUND
		line_2d.joint_mode = Line2D.LINE_JOINT_ROUND


func _populate_rune_list() -> void:
	if not rune_list:
		return

	for rune_name in ELEMENT_COLORS:
		var hbox := HBoxContainer.new()

		var color_rect := ColorRect.new()
		color_rect.custom_minimum_size = Vector2(24, 24)
		color_rect.color = ELEMENT_COLORS[rune_name]
		hbox.add_child(color_rect)

		var label := Label.new()
		label.text = \"  \" + rune_name.capitalize()
		hbox.add_child(label)

		rune_list.add_child(hbox)


func _input(event: InputEvent) -> void:
	if event.is_action_pressed(\"pause\"):
		_on_back_pressed()
		return

	if event is InputEventMouseButton and event.button_index == MOUSE_BUTTON_LEFT:
		if event.pressed:
			_start_drawing(event.position)
		else:
			_stop_drawing()

	elif event is InputEventMouseMotion and is_drawing:
		_continue_drawing(event.position)


func _start_drawing(pos: Vector2) -> void:
	is_drawing = true
	_clear_drawing()
	_add_point(pos)
	_update_feedback(\"Dibujando...\", Color(\"#00f5d4\"))

	# Resetear color de linea
	if line_2d:
		line_2d.default_color = Color(\"#00f5d4\")


func _continue_drawing(pos: Vector2) -> void:
	if points.size() > 0 and pos.distance_to(points.back()) < 3.0:
		return
	_add_point(pos)


func _stop_drawing() -> void:
	if not is_drawing:
		return
	is_drawing = false

	if points.size() < 10:
		_update_feedback(\"Muy corto - intenta de nuevo\", Color(\"#ff6b6b\"))
		return

	var result := recognizer.recognize(points)
	var score := result.Score
	var percentage := int(score * 100)

	if score >= 0.7:
		var rune_name: String = result.Name
		var color: Color = ELEMENT_COLORS.get(rune_name, Color.WHITE)
		_update_feedback(\"%s! (%d%%)\" % [rune_name.to_upper(), percentage], color)

		if line_2d:
			line_2d.default_color = color

		_add_to_history(rune_name, percentage, true)
	else:
		_update_feedback(\"No reconocido (%d%%)\" % percentage, Color(\"#ff6b6b\"))
		_add_to_history(\"???\", percentage, false)


func _add_point(pos: Vector2) -> void:
	points.append(pos)
	if line_2d:
		line_2d.add_point(pos)


func _clear_drawing() -> void:
	points.clear()
	if line_2d:
		line_2d.clear_points()


func _update_feedback(text: String, color: Color) -> void:
	if feedback_label:
		feedback_label.text = text
		feedback_label.modulate = color


func _add_to_history(rune_name: String, score: int, success: bool) -> void:
	if not history_list:
		return

	var label := Label.new()
	label.text = \"%s - %d%%\" % [rune_name.capitalize(), score]
	label.modulate = Color.GREEN if success else Color.RED

	history_list.add_child(label)
	history_list.move_child(label, 0)

	# Limitar historial a 10 entradas
	while history_list.get_child_count() > 10:
		history_list.get_child(history_list.get_child_count() - 1).queue_free()


func _on_clear_pressed() -> void:
	_clear_drawing()
	_update_feedback(\"Dibuja una runa con el mouse\", Color.WHITE)
	if line_2d:
		line_2d.default_color = Color(\"#00f5d4\")


func _on_back_pressed() -> void:
	SceneTransition.change_scene(\"res://scenes/debug/debug_menu.tscn\")
"

[node name="TestRunes" type="Control"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
theme = ExtResource("2_theme")
script = SubResource("GDScript_test_runes")

[node name="Background" type="ColorRect" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
color = Color(0.08, 0.08, 0.12, 1)

[node name="DrawArea" type="Control" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="Line2D" type="Line2D" parent="DrawArea"]
width = 8.0
default_color = Color(0, 0.960784, 0.831373, 1)
begin_cap_mode = 2
end_cap_mode = 2
joint_mode = 2

[node name="UI" type="Control" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="TitleLabel" type="Label" parent="UI"]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -150.0
offset_top = 20.0
offset_right = 150.0
offset_bottom = 60.0
grow_horizontal = 2
theme_override_colors/font_color = Color(0, 0.961, 0.831, 1)
theme_override_font_sizes/font_size = 28
text = "TEST RUNAS"
horizontal_alignment = 1

[node name="InstructionLabel" type="Label" parent="UI"]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -200.0
offset_top = 60.0
offset_right = 200.0
offset_bottom = 90.0
grow_horizontal = 2
theme_override_colors/font_color = Color(1, 1, 1, 0.6)
theme_override_font_sizes/font_size = 14
text = "Click y arrastra para dibujar - Suelta para reconocer"
horizontal_alignment = 1

[node name="FeedbackPanel" type="PanelContainer" parent="UI"]
layout_mode = 1
anchors_preset = 7
anchor_left = 0.5
anchor_top = 1.0
anchor_right = 0.5
anchor_bottom = 1.0
offset_left = -150.0
offset_top = -100.0
offset_right = 150.0
offset_bottom = -50.0
grow_horizontal = 2
grow_vertical = 0

[node name="FeedbackLabel" type="Label" parent="UI/FeedbackPanel"]
layout_mode = 2
theme_override_font_sizes/font_size = 20
text = "Dibuja una runa"
horizontal_alignment = 1
vertical_alignment = 1

[node name="RuneListPanel" type="PanelContainer" parent="UI"]
layout_mode = 1
offset_left = 20.0
offset_top = 100.0
offset_right = 180.0
offset_bottom = 320.0

[node name="VBoxContainer" type="VBoxContainer" parent="UI/RuneListPanel"]
layout_mode = 2

[node name="TitleLabel" type="Label" parent="UI/RuneListPanel/VBoxContainer"]
layout_mode = 2
theme_override_colors/font_color = Color(0, 0.961, 0.831, 1)
text = "Runas disponibles:"

[node name="HSeparator" type="HSeparator" parent="UI/RuneListPanel/VBoxContainer"]
layout_mode = 2

[node name="RuneList" type="VBoxContainer" parent="UI/RuneListPanel/VBoxContainer"]
layout_mode = 2
theme_override_constants/separation = 8

[node name="HistoryPanel" type="PanelContainer" parent="UI"]
layout_mode = 1
anchor_left = 1.0
anchor_right = 1.0
offset_left = -180.0
offset_top = 100.0
offset_right = -20.0
offset_bottom = 320.0
grow_horizontal = 0

[node name="VBoxContainer" type="VBoxContainer" parent="UI/HistoryPanel"]
layout_mode = 2

[node name="TitleLabel" type="Label" parent="UI/HistoryPanel/VBoxContainer"]
layout_mode = 2
theme_override_colors/font_color = Color(0, 0.961, 0.831, 1)
text = "Historial:"

[node name="HSeparator" type="HSeparator" parent="UI/HistoryPanel/VBoxContainer"]
layout_mode = 2

[node name="HistoryList" type="VBoxContainer" parent="UI/HistoryPanel/VBoxContainer"]
layout_mode = 2
theme_override_constants/separation = 4

[node name="ButtonsContainer" type="HBoxContainer" parent="UI"]
layout_mode = 1
anchors_preset = 7
anchor_left = 0.5
anchor_top = 1.0
anchor_right = 0.5
anchor_bottom = 1.0
offset_left = -150.0
offset_top = -40.0
offset_right = 150.0
offset_bottom = -10.0
grow_horizontal = 2
grow_vertical = 0
theme_override_constants/separation = 20

[node name="ClearBtn" type="Button" parent="UI/ButtonsContainer"]
layout_mode = 2
size_flags_horizontal = 3
text = "LIMPIAR"

[node name="BackBtn" type="Button" parent="UI/ButtonsContainer"]
layout_mode = 2
size_flags_horizontal = 3
text = "VOLVER"

[connection signal="pressed" from="UI/ButtonsContainer/ClearBtn" to="." method="_on_clear_pressed"]
[connection signal="pressed" from="UI/ButtonsContainer/BackBtn" to="." method="_on_back_pressed"]
