[gd_scene load_steps=12 format=3 uid="uid://c0qwx8m6r7hxp"]

[ext_resource type="Shader" uid="uid://bl2j4hm0jk4sd" path="res://assets/shaders/fog_background.gdshader" id="1_shader"]
[ext_resource type="Theme" uid="uid://canhs6wcwwphu" path="res://resources/theme/honk_theme.tres" id="2_theme"]
[ext_resource type="Script" uid="uid://cvvs8ogjyonwu" path="res://scripts/core/selection_manager.gd" id="3_selection"]
[ext_resource type="Script" path="res://scripts/entities/player.gd" id="4_player"]
[ext_resource type="Script" uid="uid://br5qfwuf7jgue" path="res://scenes/debug/selection_visual.gd" id="5_sel_visual"]
[ext_resource type="PackedScene" uid="uid://dkw7vqxh2m3ys" path="res://scenes/ui/hud.tscn" id="6_hud"]
[ext_resource type="Script" uid="uid://yhwtam8bv7du" path="res://scenes/debug/debug_grid.gd" id="7_grid"]
[ext_resource type="Script" path="res://scripts/core/procedural_terrain.gd" id="8_terrain"]
[ext_resource type="PackedScene" uid="uid://rune_canvas_scene" path="res://scenes/gameplay/rune_canvas.tscn" id="9_rune_canvas"]
[ext_resource type="Script" path="res://scripts/spell_system/spell_caster.gd" id="10_spell_caster"]

[sub_resource type="GDScript" id="GDScript_main_world"]
script/source = "extends Node2D

# =============================================================================
# HONK MAGIC - Main World
# =============================================================================
# Escena principal de gameplay.

@onready var player: Player = $Player
@onready var selection_manager: SelectionManager = $SelectionManager
@onready var hud: CanvasLayer = $HUD
@onready var debug_grid: Node2D = $DebugGrid
@onready var debug_hud: PanelContainer = $DebugLayer/DebugHUD
@onready var terrain: ProceduralTerrain = $Terrain
@onready var rune_canvas: CanvasLayer = $RuneCanvas
@onready var rune_mode_indicator: Label = $HUD/RuneModeIndicator
@onready var spell_caster: SpellCaster = $SpellCaster
@onready var spell_indicator: Label = $HUD/SpellIndicator

# HUD elements
@onready var hp_progress: ProgressBar = $HUD/MarginContainer/TopLeft/HPBar/HPProgress
@onready var hp_label: Label = $HUD/MarginContainer/TopLeft/HPBar/HPLabel
@onready var mp_progress: ProgressBar = $HUD/MarginContainer/TopLeft/MPBar/MPProgress
@onready var mp_label: Label = $HUD/MarginContainer/TopLeft/MPBar/MPLabel

# Debug HUD elements
@onready var fps_label: Label = $DebugLayer/DebugHUD/VBoxContainer/FPSLabel
@onready var pos_label: Label = $DebugLayer/DebugHUD/VBoxContainer/PosLabel
@onready var sel_label: Label = $DebugLayer/DebugHUD/VBoxContainer/SelLabel

# Dev Tools elements
@onready var dev_tools_panel: PanelContainer = $DevToolsLayer/DevToolsPanel
@onready var seed_spinbox: SpinBox = $DevToolsLayer/DevToolsPanel/VBoxContainer/SeedContainer/SeedSpinBox
@onready var width_spinbox: SpinBox = $DevToolsLayer/DevToolsPanel/VBoxContainer/WidthContainer/WidthSpinBox
@onready var height_spinbox: SpinBox = $DevToolsLayer/DevToolsPanel/VBoxContainer/HeightContainer/HeightSpinBox
@onready var map_name_input: LineEdit = $DevToolsLayer/DevToolsPanel/VBoxContainer/MapNameContainer/MapNameInput

var _target_indicator: Node2D = null
var _play_time_timer: float = 0.0
var _debug_mode: bool = false
var _dev_tools_mode: bool = false
var _rune_mode: bool = false
var _spell_mode: bool = false  # Esperando click para lanzar hechizo


func _ready() -> void:
	_create_target_indicator()
	selection_manager.move_command.connect(_on_move_command)
	selection_manager.selection_changed.connect(_on_selection_changed)

	# Conectar senales del player al HUD
	if player:
		player.hp_changed.connect(_on_hp_changed)
		player.mp_changed.connect(_on_mp_changed)

	# Conectar terreno
	if terrain:
		terrain.terrain_generated.connect(_on_terrain_generated)

	# Configurar spell caster
	if spell_caster:
		spell_caster.caster = player
		spell_caster.spell_cast.connect(_on_spell_cast)
		spell_caster.spell_failed.connect(_on_spell_failed)

	# Debug y Dev Tools off by default
	_set_debug_mode(false)
	_set_dev_tools_mode(false)
	_set_rune_mode_indicator(false)
	_set_spell_indicator(null)

	# Conectar rune canvas
	if rune_canvas:
		rune_canvas.rune_recognized.connect(_on_rune_recognized)
		rune_canvas.rune_cancelled.connect(_on_rune_cancelled)

	# Cargar o generar terreno
	_initialize_terrain()


func _initialize_terrain() -> void:
	if not terrain:
		return

	# Intentar cargar mapa existente
	if MapLoader.map_exists(\"default_map\"):
		MapLoader.load_map(terrain, \"default_map\")
	else:
		# Generar nuevo mapa
		terrain.generate()

	# Posicionar jugador - usar posicion guardada si existe, sino spawn valido
	if player:
		var has_saved_position := SaveManager.current_data != null and SaveManager.current_data.position != Vector2.ZERO
		if has_saved_position:
			print(\"[MainWorld] Usando posicion guardada: %s\" % SaveManager.current_data.position)
			# La posicion ya fue cargada en player._ready()
		else:
			var spawn_pos := terrain.find_spawn_position()
			print(\"[MainWorld] Nueva partida, spawn en: %s\" % spawn_pos)
			player.global_position = spawn_pos
			player.target_position = spawn_pos

		# Forzar camara a posicion correcta sin smoothing
		var camera := player.get_node_or_null(\"Camera2D\") as Camera2D
		if camera:
			print(\"[MainWorld] Forzando posicion de camara\")
			# Deshabilitar smoothing, forzar posicion, luego rehabilitar
			var was_smoothing := camera.position_smoothing_enabled
			camera.position_smoothing_enabled = false
			camera.reset_smoothing()
			# Esperar un frame y rehabilitar
			await get_tree().process_frame
			camera.position_smoothing_enabled = was_smoothing
			print(\"[MainWorld] Camara lista\")


func _on_terrain_generated(width: int, height: int) -> void:
	# Actualizar limites de camara
	var camera := player.get_node_or_null(\"Camera2D\") as Camera2D
	if camera and terrain:
		var bounds := terrain.get_map_bounds()
		camera.limit_left = int(bounds.position.x)
		camera.limit_top = int(bounds.position.y)
		camera.limit_right = int(bounds.end.x)
		camera.limit_bottom = int(bounds.end.y)


func _process(delta: float) -> void:
	# Trackear tiempo de juego
	_play_time_timer += delta
	if _play_time_timer >= 1.0:
		SaveManager.add_play_time(_play_time_timer)
		_play_time_timer = 0.0

	# Update debug HUD
	if _debug_mode:
		_update_debug_hud()


func _update_debug_hud() -> void:
	if fps_label:
		fps_label.text = \"FPS: %d\" % Engine.get_frames_per_second()
	if pos_label and player:
		pos_label.text = \"Pos: (%.0f, %.0f)\" % [player.global_position.x, player.global_position.y]


func _create_target_indicator() -> void:
	_target_indicator = Node2D.new()
	_target_indicator.set_script(preload(\"res://scenes/debug/target_indicator.gd\"))
	_target_indicator.visible = false
	add_child(_target_indicator)


func _on_move_command(target_pos: Vector2, units: Array) -> void:
	for unit in units:
		if is_instance_valid(unit) and unit.has_method(\"move_to\"):
			unit.move_to(target_pos)
	_show_target_indicator(target_pos)


func _on_selection_changed(units: Array) -> void:
	if sel_label:
		sel_label.text = \"Sel: %d\" % units.size()


func _show_target_indicator(pos: Vector2) -> void:
	if _target_indicator:
		_target_indicator.global_position = pos
		_target_indicator.visible = true
		_target_indicator.start_animation()


func _on_hp_changed(current: int, max_hp: int) -> void:
	if hp_progress:
		hp_progress.max_value = max_hp
		hp_progress.value = current
	if hp_label:
		hp_label.text = \"%d/%d\" % [current, max_hp]


func _on_mp_changed(current: int, max_mp: int) -> void:
	if mp_progress:
		mp_progress.max_value = max_mp
		mp_progress.value = current
	if mp_label:
		mp_label.text = \"%d/%d\" % [current, max_mp]


func _set_debug_mode(enabled: bool) -> void:
	_debug_mode = enabled
	if debug_grid:
		debug_grid.visible = enabled
	if debug_hud:
		debug_hud.visible = enabled


func _set_dev_tools_mode(enabled: bool) -> void:
	_dev_tools_mode = enabled
	if dev_tools_panel:
		dev_tools_panel.visible = enabled
		if enabled and terrain:
			# Sincronizar valores con el terreno actual
			seed_spinbox.value = terrain.get_current_seed()
			width_spinbox.value = terrain.map_width
			height_spinbox.value = terrain.map_height


func _input(event: InputEvent) -> void:
	if event.is_action_pressed(\"pause\") and not _rune_mode:
		if _spell_mode:
			_cancel_spell_mode()
		else:
			_save_and_exit()
	elif event.is_action_pressed(\"toggle_debug\"):
		_set_debug_mode(not _debug_mode)
	elif event.is_action_pressed(\"toggle_dev_tools\"):
		_set_dev_tools_mode(not _dev_tools_mode)
	elif event.is_action_pressed(\"toggle_rune_mode\") and not _rune_mode and not _spell_mode:
		_activate_rune_mode()
	elif _spell_mode and event is InputEventMouseButton:
		if event.button_index == MOUSE_BUTTON_LEFT:
			if event.pressed:
				_cast_spell_at_mouse()
			else:
				# Mouse up - terminar vector cast si estamos en modo vector
				if spell_caster and spell_caster.is_vector_casting:
					_finish_vector_cast()
		elif event.button_index == MOUSE_BUTTON_RIGHT and event.pressed:
			_cancel_spell_mode()


func _activate_rune_mode() -> void:
	if _rune_mode or not rune_canvas:
		return
	_rune_mode = true
	_set_rune_mode_indicator(true)
	rune_canvas.activate()
	# Desactivar selection manager mientras esta en modo runa
	if selection_manager:
		selection_manager.set_process_input(false)


func _deactivate_rune_mode() -> void:
	_rune_mode = false
	_set_rune_mode_indicator(false)
	# Reactivar selection manager
	if selection_manager:
		selection_manager.set_process_input(true)


func _set_rune_mode_indicator(enabled: bool) -> void:
	if rune_mode_indicator:
		rune_mode_indicator.visible = enabled


func _on_rune_recognized(rune_name: String, score: float) -> void:
	print(\"Runa reconocida: %s (%.0f%%)\" % [rune_name, score * 100])
	_deactivate_rune_mode()

	# Cargar hechizo correspondiente
	if spell_caster and spell_caster.charge_spell_from_rune(rune_name):
		_activate_spell_mode()


func _on_rune_cancelled() -> void:
	_deactivate_rune_mode()


func _activate_spell_mode() -> void:
	if not spell_caster or not spell_caster.charged_spell:
		return
	_spell_mode = true
	_set_spell_indicator(spell_caster.charged_spell)
	# Desactivar selection manager mientras esta en modo hechizo
	if selection_manager:
		selection_manager.set_process_input(false)


func _cancel_spell_mode() -> void:
	_spell_mode = false
	_set_spell_indicator(null)
	if spell_caster:
		spell_caster.cancel_charge()
	# Reactivar selection manager
	if selection_manager:
		selection_manager.set_process_input(true)


func _cast_spell_at_mouse() -> void:
	if not spell_caster:
		return

	var mouse_pos := get_global_mouse_position()
	if spell_caster.cast_at_position(mouse_pos):
		_spell_mode = false
		_set_spell_indicator(null)
		# Reactivar selection manager
		if selection_manager:
			selection_manager.set_process_input(true)
	elif spell_caster.is_vector_casting:
		# Iniciamos vector cast, actualizar feedback
		if spell_indicator:
			spell_indicator.text = \"ARRASTRA Y SUELTA\"


func _finish_vector_cast() -> void:
	if not spell_caster:
		return

	var end_pos := get_global_mouse_position()
	if spell_caster.finish_vector_cast(end_pos):
		_spell_mode = false
		_set_spell_indicator(null)
		# Reactivar selection manager
		if selection_manager:
			selection_manager.set_process_input(true)


func _on_spell_cast(spell: SpellResource) -> void:
	print(\"Hechizo lanzado: %s\" % spell.spell_name)


func _on_spell_failed(reason: String) -> void:
	print(\"Hechizo fallido: %s\" % reason)
	_cancel_spell_mode()


func _set_spell_indicator(spell: SpellResource) -> void:
	if spell_indicator:
		if spell:
			spell_indicator.text = spell.spell_name.to_upper()
			spell_indicator.modulate = spell.color
			spell_indicator.visible = true
		else:
			spell_indicator.visible = false


# ==================== Dev Tools Callbacks ====================

func _on_generate_pressed() -> void:
	if not terrain:
		return

	terrain.map_width = int(width_spinbox.value)
	terrain.map_height = int(height_spinbox.value)
	terrain.generate(int(seed_spinbox.value))

	# Reposicionar jugador
	if player:
		var spawn_pos := terrain.find_spawn_position()
		player.global_position = spawn_pos
		player.target_position = spawn_pos
		# Resetear camara
		var camera := player.get_node_or_null(\"Camera2D\") as Camera2D
		if camera:
			camera.reset_smoothing()


func _on_random_seed_pressed() -> void:
	seed_spinbox.value = randi()


func _on_save_map_pressed() -> void:
	if not terrain:
		return

	var map_name := map_name_input.text.strip_edges()
	if map_name.is_empty():
		map_name = \"default_map\"

	if MapLoader.save_map(terrain, map_name):
		print(\"Mapa guardado: \", map_name)


func _on_load_map_pressed() -> void:
	if not terrain:
		return

	var map_name := map_name_input.text.strip_edges()
	if map_name.is_empty():
		map_name = \"default_map\"

	if MapLoader.load_map(terrain, map_name):
		if player:
			var spawn_pos := terrain.find_spawn_position()
			player.global_position = spawn_pos
			player.target_position = spawn_pos
			# Resetear camara
			var camera := player.get_node_or_null(\"Camera2D\") as Camera2D
			if camera:
				camera.reset_smoothing()


# ==================== Save & Exit ====================

func _save_and_exit() -> void:
	# Guardar estado del jugador
	if player:
		player.save_state()
	SaveManager.save_game()

	# Volver al menu principal
	SceneTransition.change_scene(\"res://scenes/ui/main_menu.tscn\")


func _notification(what: int) -> void:
	# Auto-guardar al salir
	if what == NOTIFICATION_WM_CLOSE_REQUEST:
		if player:
			player.save_state()
		SaveManager.save_game()
"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_bg"]
shader = ExtResource("1_shader")
shader_parameter/color_deep = Color(0.0588235, 0.0588235, 0.101961, 1)
shader_parameter/color_mid = Color(0.101961, 0.101961, 0.180392, 1)
shader_parameter/color_light = Color(0.0862745, 0.129412, 0.180392, 1)
shader_parameter/color_accent = Color(0.172549, 0.415686, 0.309804, 0.3)
shader_parameter/fog_speed = 0.02
shader_parameter/fog_scale = 12.0
shader_parameter/fog_intensity = 0.25
shader_parameter/particle_density = 20.0
shader_parameter/particle_size = 0.003
shader_parameter/particle_glow = 0.5

[sub_resource type="CircleShape2D" id="CircleShape2D_player"]
radius = 30.0

[node name="MainWorld" type="Node2D"]
script = SubResource("GDScript_main_world")

[node name="Background" type="ColorRect" parent="."]
z_index = -100
material = SubResource("ShaderMaterial_bg")
offset_left = -3000.0
offset_top = -3000.0
offset_right = 3000.0
offset_bottom = 3000.0

[node name="Terrain" type="TileMapLayer" parent="."]
z_index = -10
texture_filter = 0
script = ExtResource("8_terrain")

[node name="DebugGrid" type="Node2D" parent="."]
visible = false
z_index = -5
script = ExtResource("7_grid")

[node name="SelectionManager" type="Node2D" parent="."]
script = ExtResource("3_selection")

[node name="Player" type="CharacterBody2D" parent="."]
texture_filter = 0
script = ExtResource("4_player")

[node name="Visual" type="Polygon2D" parent="Player"]
color = Color(0.878431, 0.878431, 0.878431, 1)
polygon = PackedVector2Array(26, -15, 26, 15, 0, 30, -26, 15, -26, -15, 0, -30)

[node name="SelectionVisual" type="Node2D" parent="Player"]
visible = false
script = ExtResource("5_sel_visual")

[node name="CollisionShape2D" type="CollisionShape2D" parent="Player"]
shape = SubResource("CircleShape2D_player")

[node name="Camera2D" type="Camera2D" parent="Player"]
position_smoothing_enabled = true

[node name="HUD" parent="." instance=ExtResource("6_hud")]

[node name="DebugLayer" type="CanvasLayer" parent="."]
layer = 100

[node name="DebugHUD" type="PanelContainer" parent="DebugLayer"]
visible = false
anchors_preset = 1
anchor_left = 1.0
anchor_right = 1.0
offset_left = -200.0
offset_top = 10.0
offset_right = -10.0
offset_bottom = 100.0
grow_horizontal = 0
theme = ExtResource("2_theme")

[node name="VBoxContainer" type="VBoxContainer" parent="DebugLayer/DebugHUD"]
layout_mode = 2
theme_override_constants/separation = 4

[node name="FPSLabel" type="Label" parent="DebugLayer/DebugHUD/VBoxContainer"]
layout_mode = 2
theme_override_font_sizes/font_size = 16
text = "FPS: 60"

[node name="PosLabel" type="Label" parent="DebugLayer/DebugHUD/VBoxContainer"]
layout_mode = 2
theme_override_font_sizes/font_size = 16
text = "Pos: (0, 0)"

[node name="SelLabel" type="Label" parent="DebugLayer/DebugHUD/VBoxContainer"]
layout_mode = 2
theme_override_font_sizes/font_size = 16
text = "Sel: 0"

[node name="DevToolsLayer" type="CanvasLayer" parent="."]
layer = 101

[node name="DevToolsPanel" type="PanelContainer" parent="DevToolsLayer"]
visible = false
anchors_preset = 1
anchor_left = 1.0
anchor_right = 1.0
offset_left = -280.0
offset_top = 120.0
offset_right = -10.0
offset_bottom = 420.0
grow_horizontal = 0
theme = ExtResource("2_theme")

[node name="VBoxContainer" type="VBoxContainer" parent="DevToolsLayer/DevToolsPanel"]
layout_mode = 2
theme_override_constants/separation = 8

[node name="TitleLabel" type="Label" parent="DevToolsLayer/DevToolsPanel/VBoxContainer"]
layout_mode = 2
theme_override_colors/font_color = Color(0, 0.961, 0.831, 1)
theme_override_font_sizes/font_size = 18
text = "DEV TOOLS (F4)"
horizontal_alignment = 1

[node name="HSeparator" type="HSeparator" parent="DevToolsLayer/DevToolsPanel/VBoxContainer"]
layout_mode = 2

[node name="SeedContainer" type="HBoxContainer" parent="DevToolsLayer/DevToolsPanel/VBoxContainer"]
layout_mode = 2

[node name="SeedLabel" type="Label" parent="DevToolsLayer/DevToolsPanel/VBoxContainer/SeedContainer"]
layout_mode = 2
text = "Seed:"

[node name="SeedSpinBox" type="SpinBox" parent="DevToolsLayer/DevToolsPanel/VBoxContainer/SeedContainer"]
layout_mode = 2
size_flags_horizontal = 3
min_value = 0.0
max_value = 999999.0
value = 12345.0

[node name="RandomSeedBtn" type="Button" parent="DevToolsLayer/DevToolsPanel/VBoxContainer/SeedContainer"]
layout_mode = 2
text = "Rand"

[node name="WidthContainer" type="HBoxContainer" parent="DevToolsLayer/DevToolsPanel/VBoxContainer"]
layout_mode = 2

[node name="WidthLabel" type="Label" parent="DevToolsLayer/DevToolsPanel/VBoxContainer/WidthContainer"]
layout_mode = 2
text = "Width:"

[node name="WidthSpinBox" type="SpinBox" parent="DevToolsLayer/DevToolsPanel/VBoxContainer/WidthContainer"]
layout_mode = 2
size_flags_horizontal = 3
min_value = 20.0
max_value = 200.0
value = 80.0

[node name="HeightContainer" type="HBoxContainer" parent="DevToolsLayer/DevToolsPanel/VBoxContainer"]
layout_mode = 2

[node name="HeightLabel" type="Label" parent="DevToolsLayer/DevToolsPanel/VBoxContainer/HeightContainer"]
layout_mode = 2
text = "Height:"

[node name="HeightSpinBox" type="SpinBox" parent="DevToolsLayer/DevToolsPanel/VBoxContainer/HeightContainer"]
layout_mode = 2
size_flags_horizontal = 3
min_value = 20.0
max_value = 200.0
value = 60.0

[node name="GenerateBtn" type="Button" parent="DevToolsLayer/DevToolsPanel/VBoxContainer"]
layout_mode = 2
text = "Generar Mapa"

[node name="HSeparator2" type="HSeparator" parent="DevToolsLayer/DevToolsPanel/VBoxContainer"]
layout_mode = 2

[node name="MapNameContainer" type="HBoxContainer" parent="DevToolsLayer/DevToolsPanel/VBoxContainer"]
layout_mode = 2

[node name="MapNameLabel" type="Label" parent="DevToolsLayer/DevToolsPanel/VBoxContainer/MapNameContainer"]
layout_mode = 2
text = "Nombre:"

[node name="MapNameInput" type="LineEdit" parent="DevToolsLayer/DevToolsPanel/VBoxContainer/MapNameContainer"]
layout_mode = 2
size_flags_horizontal = 3
text = "default_map"

[node name="ButtonsContainer" type="HBoxContainer" parent="DevToolsLayer/DevToolsPanel/VBoxContainer"]
layout_mode = 2
theme_override_constants/separation = 8

[node name="SaveMapBtn" type="Button" parent="DevToolsLayer/DevToolsPanel/VBoxContainer/ButtonsContainer"]
layout_mode = 2
size_flags_horizontal = 3
text = "Guardar"

[node name="LoadMapBtn" type="Button" parent="DevToolsLayer/DevToolsPanel/VBoxContainer/ButtonsContainer"]
layout_mode = 2
size_flags_horizontal = 3
text = "Cargar"

[node name="RuneCanvas" parent="." instance=ExtResource("9_rune_canvas")]

[node name="SpellCaster" type="Node2D" parent="."]
script = ExtResource("10_spell_caster")

[node name="RuneModeIndicator" type="Label" parent="HUD"]
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -100.0
offset_top = 20.0
offset_right = 100.0
offset_bottom = 60.0
grow_horizontal = 2
theme_override_colors/font_color = Color(0, 0.961, 0.831, 1)
theme_override_font_sizes/font_size = 24
text = "MODO RUNA"
horizontal_alignment = 1
vertical_alignment = 1

[node name="SpellIndicator" type="Label" parent="HUD"]
visible = false
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -150.0
offset_top = 70.0
offset_right = 150.0
offset_bottom = 110.0
grow_horizontal = 2
theme_override_colors/font_color = Color(1, 1, 1, 1)
theme_override_font_sizes/font_size = 20
text = "HECHIZO CARGADO"
horizontal_alignment = 1
vertical_alignment = 1

[connection signal="pressed" from="DevToolsLayer/DevToolsPanel/VBoxContainer/SeedContainer/RandomSeedBtn" to="." method="_on_random_seed_pressed"]
[connection signal="pressed" from="DevToolsLayer/DevToolsPanel/VBoxContainer/GenerateBtn" to="." method="_on_generate_pressed"]
[connection signal="pressed" from="DevToolsLayer/DevToolsPanel/VBoxContainer/ButtonsContainer/SaveMapBtn" to="." method="_on_save_map_pressed"]
[connection signal="pressed" from="DevToolsLayer/DevToolsPanel/VBoxContainer/ButtonsContainer/LoadMapBtn" to="." method="_on_load_map_pressed"]
