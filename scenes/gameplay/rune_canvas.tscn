[gd_scene load_steps=3 format=3 uid="uid://rune_canvas_scene"]

[ext_resource type="Theme" uid="uid://canhs6wcwwphu" path="res://resources/theme/honk_theme.tres" id="1_theme"]

[sub_resource type="GDScript" id="GDScript_rune_canvas"]
script/source = "extends CanvasLayer

# =============================================================================
# HONK MAGIC - Rune Canvas
# =============================================================================
# Modal para dibujar y reconocer runas magicas.

signal rune_recognized(rune_name: String, score: float)
signal rune_cancelled()

@onready var dimmer: ColorRect = $Dimmer
@onready var draw_area: Control = $DrawArea
@onready var line_2d: Line2D = $DrawArea/Line2D
@onready var feedback_label: Label = $UI/FeedbackContainer/FeedbackLabel
@onready var rune_icons: HBoxContainer = $UI/RuneIconsContainer/RuneIcons
@onready var instruction_label: Label = $UI/InstructionLabel

var recognizer: DollarRecognizer
var points: Array[Vector2] = []
var is_drawing: bool = false
var is_active: bool = false

# Colores de elementos
const ELEMENT_COLORS := {
	\"fuego\": Color(\"#e63946\"),
	\"agua\": Color(\"#0077b6\"),
	\"viento\": Color(\"#90e0ef\"),
	\"tierra\": Color(\"#bc6c25\"),
	\"luz\": Color(\"#ffd60a\"),
	\"oscuridad\": Color(\"#7b2cbf\")
}

const MIN_RECOGNITION_SCORE := 0.7


func _ready() -> void:
	recognizer = DollarRecognizer.new()
	_setup_line()
	_populate_rune_icons()
	hide()
	set_process_input(false)


func _setup_line() -> void:
	if line_2d:
		line_2d.width = 8.0
		line_2d.default_color = Color(\"#00f5d4\")
		line_2d.begin_cap_mode = Line2D.LINE_CAP_ROUND
		line_2d.end_cap_mode = Line2D.LINE_CAP_ROUND
		line_2d.joint_mode = Line2D.LINE_JOINT_ROUND


func _populate_rune_icons() -> void:
	if not rune_icons:
		return

	# Limpiar iconos existentes
	for child in rune_icons.get_children():
		child.queue_free()

	# Crear iconos para cada runa
	for rune_name in ELEMENT_COLORS:
		var icon := _create_rune_icon(rune_name)
		rune_icons.add_child(icon)


func _create_rune_icon(rune_name: String) -> Control:
	var container := VBoxContainer.new()
	container.size_flags_horizontal = Control.SIZE_EXPAND_FILL

	# Circulo de color
	var color_rect := ColorRect.new()
	color_rect.custom_minimum_size = Vector2(48, 48)
	color_rect.color = ELEMENT_COLORS.get(rune_name, Color.WHITE)
	container.add_child(color_rect)

	# Nombre
	var label := Label.new()
	label.text = rune_name.capitalize()
	label.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
	label.add_theme_font_size_override(\"font_size\", 12)
	container.add_child(label)

	return container


func activate() -> void:
	if is_active:
		return

	is_active = true
	show()
	set_process_input(true)
	_clear_drawing()
	_update_feedback(\"Dibuja una runa...\", Color.WHITE)

	# Animar entrada (usando dimmer)
	if dimmer:
		dimmer.modulate.a = 0.0
		var tween := create_tween()
		tween.tween_property(dimmer, \"modulate:a\", 1.0, 0.15)


func deactivate() -> void:
	if not is_active:
		return

	is_active = false
	is_drawing = false

	# Animar salida (usando dimmer)
	if dimmer:
		var tween := create_tween()
		tween.tween_property(dimmer, \"modulate:a\", 0.0, 0.15)
		tween.tween_callback(func():
			hide()
			set_process_input(false)
		)
	else:
		hide()
		set_process_input(false)


func _input(event: InputEvent) -> void:
	if not is_active:
		return

	# Soltar ESPACIO reconoce la runa
	if event.is_action_released(\"toggle_rune_mode\"):
		_finish_and_recognize()
		get_viewport().set_input_as_handled()
		return

	# ESC cancela
	if event.is_action_pressed(\"pause\"):
		_cancel()
		get_viewport().set_input_as_handled()
		return

	# Dibujo con mouse
	if event is InputEventMouseButton and event.button_index == MOUSE_BUTTON_LEFT:
		if event.pressed:
			_start_drawing(event.position)

	elif event is InputEventMouseMotion and is_drawing:
		_continue_drawing(event.position)


func _start_drawing(pos: Vector2) -> void:
	is_drawing = true
	_clear_drawing()
	_add_point(pos)
	_update_feedback(\"Dibujando...\", Color(\"#00f5d4\"))


func _continue_drawing(pos: Vector2) -> void:
	if points.size() > 0 and pos.distance_to(points.back()) < 3.0:
		return
	_add_point(pos)


func _add_point(pos: Vector2) -> void:
	points.append(pos)
	if line_2d:
		line_2d.add_point(pos)


func _clear_drawing() -> void:
	points.clear()
	if line_2d:
		line_2d.clear_points()


func _finish_and_recognize() -> void:
	is_drawing = false

	if points.size() < 10:
		_update_feedback(\"Muy corto\", Color(\"#ff6b6b\"))
		await get_tree().create_timer(0.3).timeout
		rune_cancelled.emit()
		deactivate()
		return

	var result := recognizer.recognize(points)
	var score := result.Score

	if score >= MIN_RECOGNITION_SCORE:
		var rune_name: String = result.Name
		var color: Color = ELEMENT_COLORS.get(rune_name, Color.WHITE)
		_update_feedback(\"%s! (%d%%)\" % [rune_name.to_upper(), int(score * 100)], color)

		# Cambiar color de la linea al elemento
		if line_2d:
			line_2d.default_color = color

		# Emitir senal y cerrar despues de un momento
		await get_tree().create_timer(0.5).timeout
		rune_recognized.emit(rune_name, score)
		deactivate()
	else:
		_update_feedback(\"No reconocido (%d%%)\" % int(score * 100), Color(\"#ff6b6b\"))
		await get_tree().create_timer(0.3).timeout
		rune_cancelled.emit()
		deactivate()


func _cancel() -> void:
	rune_cancelled.emit()
	deactivate()


func _update_feedback(text: String, color: Color) -> void:
	if feedback_label:
		feedback_label.text = text
		feedback_label.modulate = color
"

[node name="RuneCanvas" type="CanvasLayer"]
layer = 10
script = SubResource("GDScript_rune_canvas")

[node name="Dimmer" type="ColorRect" parent="."]
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
color = Color(0, 0, 0, 0.7)

[node name="DrawArea" type="Control" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="Line2D" type="Line2D" parent="DrawArea"]
width = 8.0
default_color = Color(0, 0.960784, 0.831373, 1)
begin_cap_mode = 2
end_cap_mode = 2
joint_mode = 2

[node name="UI" type="Control" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
theme = ExtResource("1_theme")

[node name="InstructionLabel" type="Label" parent="UI"]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -200.0
offset_top = 50.0
offset_right = 200.0
offset_bottom = 90.0
grow_horizontal = 2
theme_override_colors/font_color = Color(1, 1, 1, 0.7)
theme_override_font_sizes/font_size = 18
text = "Mant√©n ESPACIO y dibuja - Suelta para reconocer"
horizontal_alignment = 1

[node name="FeedbackContainer" type="PanelContainer" parent="UI"]
layout_mode = 1
anchors_preset = 7
anchor_left = 0.5
anchor_top = 1.0
anchor_right = 0.5
anchor_bottom = 1.0
offset_left = -150.0
offset_top = -120.0
offset_right = 150.0
offset_bottom = -60.0
grow_horizontal = 2
grow_vertical = 0

[node name="FeedbackLabel" type="Label" parent="UI/FeedbackContainer"]
layout_mode = 2
theme_override_font_sizes/font_size = 24
text = "Dibuja una runa..."
horizontal_alignment = 1
vertical_alignment = 1

[node name="RuneIconsContainer" type="PanelContainer" parent="UI"]
layout_mode = 1
anchors_preset = 7
anchor_left = 0.5
anchor_top = 1.0
anchor_right = 0.5
anchor_bottom = 1.0
offset_left = -250.0
offset_top = -200.0
offset_right = 250.0
offset_bottom = -140.0
grow_horizontal = 2
grow_vertical = 0

[node name="RuneIcons" type="HBoxContainer" parent="UI/RuneIconsContainer"]
layout_mode = 2
theme_override_constants/separation = 16
alignment = 1
