[gd_scene load_steps=5 format=3 uid="uid://dysv8k3xpqf2m"]

[ext_resource type="Shader" uid="uid://bl2j4hm0jk4sd" path="res://assets/shaders/fog_background.gdshader" id="1_shader"]
[ext_resource type="Theme" uid="uid://canhs6wcwwphu" path="res://resources/theme/honk_theme.tres" id="2_theme"]

[sub_resource type="GDScript" id="GDScript_save_select"]
script/source = "extends Control

# =============================================================================
# HONK MAGIC - Save Select Screen
# =============================================================================

@export var slot_container: HBoxContainer
@export var name_modal: PanelContainer
@export var name_input: LineEdit

var _selected_slot: int = -1
var _slot_panels: Array[PanelContainer] = []


func _ready() -> void:
	_setup_slots()
	_refresh_slots()
	_hide_modal()
	_animate_entrance()


func _animate_entrance() -> void:
	modulate.a = 0.0
	var tween := create_tween()
	tween.tween_property(self, \"modulate:a\", 1.0, 0.3)


func _setup_slots() -> void:
	if not slot_container:
		return

	_slot_panels.clear()
	for i in range(SaveManager.MAX_SLOTS):
		var panel := _create_slot_panel(i)
		slot_container.add_child(panel)
		_slot_panels.append(panel)


func _create_slot_panel(slot_index: int) -> PanelContainer:
	var panel := PanelContainer.new()
	panel.custom_minimum_size = Vector2(350, 400)
	panel.size_flags_horizontal = Control.SIZE_EXPAND_FILL

	var margin := MarginContainer.new()
	margin.add_theme_constant_override(\"margin_left\", 20)
	margin.add_theme_constant_override(\"margin_top\", 20)
	margin.add_theme_constant_override(\"margin_right\", 20)
	margin.add_theme_constant_override(\"margin_bottom\", 20)
	panel.add_child(margin)

	var vbox := VBoxContainer.new()
	vbox.add_theme_constant_override(\"separation\", 16)
	margin.add_child(vbox)

	# Slot title
	var title := Label.new()
	title.name = \"SlotTitle\"
	title.text = tr(\"SAVE_SLOT\") + \" \" + str(slot_index + 1)
	title.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
	title.add_theme_font_size_override(\"font_size\", 28)
	title.add_theme_color_override(\"font_color\", Color(0.9, 0.9, 0.9))
	vbox.add_child(title)

	# Separator
	var sep := HSeparator.new()
	vbox.add_child(sep)

	# Player name
	var name_label := Label.new()
	name_label.name = \"PlayerName\"
	name_label.text = tr(\"SAVE_EMPTY\")
	name_label.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
	name_label.add_theme_font_size_override(\"font_size\", 24)
	name_label.add_theme_color_override(\"font_color\", Color(0.7, 0.7, 0.7))
	vbox.add_child(name_label)

	# Play time
	var time_label := Label.new()
	time_label.name = \"PlayTime\"
	time_label.text = \"\"
	time_label.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
	time_label.add_theme_font_size_override(\"font_size\", 18)
	time_label.add_theme_color_override(\"font_color\", Color(0.6, 0.6, 0.6))
	vbox.add_child(time_label)

	# Spacer
	var spacer := Control.new()
	spacer.size_flags_vertical = Control.SIZE_EXPAND_FILL
	vbox.add_child(spacer)

	# Buttons container
	var btn_container := VBoxContainer.new()
	btn_container.name = \"ButtonContainer\"
	btn_container.add_theme_constant_override(\"separation\", 10)
	vbox.add_child(btn_container)

	# Play/Create button
	var play_btn := Button.new()
	play_btn.name = \"PlayButton\"
	play_btn.text = tr(\"SAVE_NEW\")
	play_btn.custom_minimum_size = Vector2(0, 50)
	play_btn.pressed.connect(_on_slot_play_pressed.bind(slot_index))
	btn_container.add_child(play_btn)

	# Delete button (hidden for empty slots)
	var delete_btn := Button.new()
	delete_btn.name = \"DeleteButton\"
	delete_btn.text = tr(\"SAVE_DELETE\")
	delete_btn.custom_minimum_size = Vector2(0, 40)
	delete_btn.visible = false
	delete_btn.pressed.connect(_on_slot_delete_pressed.bind(slot_index))
	btn_container.add_child(delete_btn)

	return panel


func _refresh_slots() -> void:
	var slots_info := SaveManager.get_all_slots_info()

	for i in range(_slot_panels.size()):
		var panel := _slot_panels[i]
		var info: Dictionary = slots_info[i]
		var is_empty := info.is_empty()

		var name_label: Label = panel.find_child(\"PlayerName\", true, false)
		var time_label: Label = panel.find_child(\"PlayTime\", true, false)
		var play_btn: Button = panel.find_child(\"PlayButton\", true, false)
		var delete_btn: Button = panel.find_child(\"DeleteButton\", true, false)

		if is_empty:
			name_label.text = tr(\"SAVE_EMPTY\")
			name_label.add_theme_color_override(\"font_color\", Color(0.5, 0.5, 0.5))
			time_label.text = \"\"
			play_btn.text = tr(\"SAVE_NEW\")
			delete_btn.visible = false
		else:
			name_label.text = info.get(\"player_name\", \"???\")
			name_label.add_theme_color_override(\"font_color\", Color(0.9, 0.8, 0.6))
			var play_time: float = info.get(\"play_time\", 0.0)
			time_label.text = SaveManager.get_formatted_play_time(play_time)
			play_btn.text = tr(\"SAVE_PLAY\")
			delete_btn.visible = true


func _on_slot_play_pressed(slot_index: int) -> void:
	if SaveManager.slot_exists(slot_index):
		# Load existing game
		if SaveManager.load_game(slot_index):
			_go_to_gameplay()
	else:
		# Show name input modal for new game
		_selected_slot = slot_index
		_show_modal()


func _on_slot_delete_pressed(slot_index: int) -> void:
	# TODO: Add confirmation dialog
	SaveManager.delete_slot(slot_index)
	_refresh_slots()


func _show_modal() -> void:
	if name_modal:
		name_modal.visible = true
		if name_input:
			name_input.text = \"\"
			name_input.grab_focus()


func _hide_modal() -> void:
	if name_modal:
		name_modal.visible = false


func _on_create_pressed() -> void:
	if not name_input:
		return

	var player_name := name_input.text.strip_edges()
	if player_name.is_empty():
		# TODO: Show error feedback
		return

	if SaveManager.create_new_game(_selected_slot, player_name):
		_hide_modal()
		_refresh_slots()
		_go_to_gameplay()


func _on_cancel_pressed() -> void:
	_hide_modal()
	_selected_slot = -1


func _on_name_input_submitted(new_text: String) -> void:
	_on_create_pressed()


func _go_to_gameplay() -> void:
	SceneTransition.change_scene(\"res://scenes/gameplay/main_world.tscn\")


func _on_back_pressed() -> void:
	SceneTransition.change_scene(\"res://scenes/ui/main_menu.tscn\")


func _input(event: InputEvent) -> void:
	if event.is_action_pressed(\"pause\"):
		if name_modal and name_modal.visible:
			_hide_modal()
		else:
			_on_back_pressed()
"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_bg"]
shader = ExtResource("1_shader")
shader_parameter/color_deep = Color(0.0588235, 0.0588235, 0.101961, 1)
shader_parameter/color_mid = Color(0.101961, 0.101961, 0.180392, 1)
shader_parameter/color_light = Color(0.0862745, 0.129412, 0.243137, 1)
shader_parameter/color_accent = Color(0.482353, 0.172549, 0.74902, 0.3)
shader_parameter/fog_speed = 0.025
shader_parameter/fog_scale = 10.0
shader_parameter/fog_intensity = 0.3
shader_parameter/particle_density = 25.0
shader_parameter/particle_size = 0.004
shader_parameter/particle_glow = 0.7

[node name="SaveSelect" type="Control" node_paths=PackedStringArray("slot_container", "name_modal", "name_input")]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
theme = ExtResource("2_theme")
script = SubResource("GDScript_save_select")
slot_container = NodePath("MarginContainer/VBoxContainer/SlotContainer")
name_modal = NodePath("NameModal")
name_input = NodePath("NameModal/MarginContainer/VBoxContainer/NameInput")

[node name="Background" type="ColorRect" parent="."]
material = SubResource("ShaderMaterial_bg")
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="MarginContainer" type="MarginContainer" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
theme_override_constants/margin_left = 100
theme_override_constants/margin_top = 50
theme_override_constants/margin_right = 100
theme_override_constants/margin_bottom = 50

[node name="VBoxContainer" type="VBoxContainer" parent="MarginContainer"]
layout_mode = 2
alignment = 1

[node name="TitleLabel" type="Label" parent="MarginContainer/VBoxContainer"]
auto_translate_mode = 1
layout_mode = 2
theme_override_colors/font_color = Color(0.878431, 0.878431, 0.878431, 1)
theme_override_colors/font_outline_color = Color(0.482353, 0.172549, 0.74902, 1)
theme_override_constants/outline_size = 4
theme_override_font_sizes/font_size = 56
text = "SAVE_SELECT"
horizontal_alignment = 1

[node name="Spacer" type="Control" parent="MarginContainer/VBoxContainer"]
custom_minimum_size = Vector2(0, 40)
layout_mode = 2

[node name="SlotContainer" type="HBoxContainer" parent="MarginContainer/VBoxContainer"]
layout_mode = 2
size_flags_horizontal = 4
theme_override_constants/separation = 30

[node name="Spacer2" type="Control" parent="MarginContainer/VBoxContainer"]
custom_minimum_size = Vector2(0, 40)
layout_mode = 2

[node name="BackButton" type="Button" parent="MarginContainer/VBoxContainer"]
auto_translate_mode = 1
custom_minimum_size = Vector2(200, 56)
layout_mode = 2
size_flags_horizontal = 4
text = "MENU_BACK"

[node name="ModalDimmer" type="ColorRect" parent="."]
visible = false
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
color = Color(0, 0, 0, 0.7)

[node name="NameModal" type="PanelContainer" parent="."]
visible = false
layout_mode = 1
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -250.0
offset_top = -150.0
offset_right = 250.0
offset_bottom = 150.0
grow_horizontal = 2
grow_vertical = 2

[node name="MarginContainer" type="MarginContainer" parent="NameModal"]
layout_mode = 2
theme_override_constants/margin_left = 30
theme_override_constants/margin_top = 30
theme_override_constants/margin_right = 30
theme_override_constants/margin_bottom = 30

[node name="VBoxContainer" type="VBoxContainer" parent="NameModal/MarginContainer"]
layout_mode = 2
theme_override_constants/separation = 20

[node name="PromptLabel" type="Label" parent="NameModal/MarginContainer/VBoxContainer"]
auto_translate_mode = 1
layout_mode = 2
theme_override_colors/font_color = Color(0.9, 0.9, 0.9, 1)
theme_override_font_sizes/font_size = 22
text = "SAVE_NAME_PROMPT"
horizontal_alignment = 1
autowrap_mode = 2

[node name="NameInput" type="LineEdit" parent="NameModal/MarginContainer/VBoxContainer"]
custom_minimum_size = Vector2(0, 50)
layout_mode = 2
theme_override_font_sizes/font_size = 24
placeholder_text = "..."
alignment = 1
max_length = 20

[node name="ButtonContainer" type="HBoxContainer" parent="NameModal/MarginContainer/VBoxContainer"]
layout_mode = 2
theme_override_constants/separation = 20

[node name="CancelButton" type="Button" parent="NameModal/MarginContainer/VBoxContainer/ButtonContainer"]
auto_translate_mode = 1
custom_minimum_size = Vector2(150, 50)
layout_mode = 2
size_flags_horizontal = 3
text = "SAVE_CANCEL"

[node name="CreateButton" type="Button" parent="NameModal/MarginContainer/VBoxContainer/ButtonContainer"]
auto_translate_mode = 1
custom_minimum_size = Vector2(150, 50)
layout_mode = 2
size_flags_horizontal = 3
theme_type_variation = "PrimaryButton"
text = "SAVE_CREATE"

[connection signal="pressed" from="MarginContainer/VBoxContainer/BackButton" to="." method="_on_back_pressed"]
[connection signal="text_submitted" from="NameModal/MarginContainer/VBoxContainer/NameInput" to="." method="_on_name_input_submitted"]
[connection signal="pressed" from="NameModal/MarginContainer/VBoxContainer/ButtonContainer/CancelButton" to="." method="_on_cancel_pressed"]
[connection signal="pressed" from="NameModal/MarginContainer/VBoxContainer/ButtonContainer/CreateButton" to="." method="_on_create_pressed"]
